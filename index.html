<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í¬ë¡¬ë¶ ì¶©ì „í•¨ ì¹´ë“œí‚¤ ëŒ€ì—¬í”„ë¡œê·¸ë¨</title>
  <style>
    :root{
      --bg:#f6f7fb; --panel:#ffffff; --ink:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --accent:#2563eb; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "ë§‘ì€ ê³ ë”•", Arial, sans-serif}
    .wrap{max-width:1180px;margin:22px auto 120px;padding:0 16px}
    h1{margin:0 0 8px;font-size:26px;text-align:center}
    .muted{color:var(--muted);font-size:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:end}
    .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-1{grid-column:span 1}
    label{display:block;font-size:12px;font-weight:700;color:#334155;margin-bottom:6px}
    input[type="text"],input[type="date"],select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .periods{display:flex;gap:6px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-primary{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn-ghost{background:#e0e7ff;color:#1e3a8a;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn-danger{background:var(--danger);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    thead th{background:#f1f5f9;text-align:left;padding:9px 10px;font-size:12px;color:#334155;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:1}
    tbody td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:last-child td{border-bottom:none}
    .center{text-align:center}
    .right{display:flex;justify-content:flex-end}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .tag.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .tag.wait{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    dialog{border:none;border-radius:14px;padding:0;width:min(900px,92vw);box-shadow:0 24px 60px rgba(0,0,0,.25)}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal{padding:16px}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal h3{margin:0;font-size:18px}
    .close{background:#eef2ff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer}
    /* í‘œ ìŠ¤í¬ë¡¤ */
    .scroll-area{max-height:460px;overflow:auto;border-radius:12px}
    /* ì •ë ¬ ë²„íŠ¼ (thead) */
    .sort-group{display:inline-flex;gap:4px;margin-left:6px;vertical-align:middle}
    .sortbtn{padding:2px 6px;border:1px solid var(--line);border-radius:6px;background:#fff;cursor:pointer;font-size:11px;line-height:1}
    .sortbtn.active{background:#dbeafe;border-color:#93c5fd}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>í¬ë¡¬ë¶ ì¶©ì „í•¨ ì¹´ë“œí‚¤ ëŒ€ì—¬í”„ë¡œê·¸ë¨</h1>

    <!-- ìƒë‹¨: ì¡°íšŒ ë‚ ì§œ / í†µê³„ -->
    <div class="inline" style="justify-content:space-between;margin:8px 0 12px">
      <div>
        <label for="datePicker">ì¡°íšŒ ë‚ ì§œ</label>
        <input type="date" id="datePicker" style="width:200px"/>
      </div>
      <div class="inline">
        <button class="btn-ghost" id="statsBtn">ğŸ“Š ì›”ë³„ í†µê³„</button>
        <label class="inline" style="gap:6px">
          <span class="muted">ë¯¸ë°˜ë‚©ë§Œ ë³´ê¸°</span>
          <input type="checkbox" id="unreturnedOnly" />
        </label>
      </div>
    </div>

    <!-- ì…ë ¥ íŒ¨ë„ -->
    <section class="panel" aria-label="ì…ë ¥ ì˜ì—­">
      <div class="grid">
        <!-- êµì‹œ -->
        <div class="col-3">
          <label>êµì‹œ (1~7, ë°©ê³¼í›„)</label>
          <div id="periodButtons" class="periods"></div>
        </div>
        <!-- ì‚¬ìš©ì -->
        <div class="col-3">
          <label for="teacherInput">ì‚¬ìš©ì(êµì‚¬)</label>
          <input type="text" id="teacherInput" placeholder="ì˜ˆ: ì†ì„±í•„" autocomplete="off"/>
        </div>
        <!-- í•™ë…„ -->
        <div class="col-2">
          <label for="gradeSelect">í•™ë…„</label>
          <select id="gradeSelect">
            <option value="1í•™ë…„">1í•™ë…„</option>
            <option value="2í•™ë…„">2í•™ë…„</option>
            <option value="3í•™ë…„">3í•™ë…„</option>
          </select>
        </div>
        <!-- í•™ê³¼ -->
        <div class="col-2">
          <label for="deptSelect">í•™ê³¼</label>
          <select id="deptSelect"></select>
        </div>
        <!-- ë°˜ -->
        <div class="col-1">
          <label for="classSelect">ë°˜</label>
          <select id="classSelect">
            <option value="1ë°˜">1ë°˜</option>
            <option value="2ë°˜">2ë°˜</option>
            <option value="3ë°˜">3ë°˜</option>
          </select>
        </div>
        <!-- ëŒ€ì—¬ ë“±ë¡ ë²„íŠ¼ë§Œ (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
        <div class="col-1">
          <label style="visibility:hidden">ë“±ë¡</label>
          <div class="right">
            <button class="btn-danger" id="addBtn">ï¼‹ ëŒ€ì—¬ ë“±ë¡</button>
          </div>
        </div>

        <div class="col-12 muted" style="margin-top:4px">
          â€» ë°˜ë‚© í™•ì¸ ì²´í¬ ì‹œ, ë°˜ë‚©ì¼ì‹œê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.
        </div>
      </div>
    </section>

    <!-- í‘œ -->
    <section class="panel" style="margin-top:14px">
      <div class="inline" style="justify-content:space-between;margin-bottom:6px">
        <span class="muted">ì˜¤ëŠ˜ í¬í•¨ ì›í•˜ëŠ” ë‚ ì§œë¥¼ ì„ íƒí•´ ì¡°íšŒí•˜ì„¸ìš”.</span>
        <span class="muted"><span id="recordCount">0</span>ê±´</span>
      </div>
      <div class="scroll-area">
        <table id="dataTable" aria-label="ëŒ€ì—¬ ê¸°ë¡ í…Œì´ë¸”">
          <thead id="tableHead">
            <tr>
              <th style="width:60px">ì—°ë²ˆ</th>
              <th style="width:96px">êµì‹œ</th>
              <th style="width:180px">ì‚¬ìš©ì(êµì‚¬)</th>
              <th style="width:120px">
                í•™ë…„
                <span class="sort-group">
                  <button class="sortbtn" data-sort="grade" data-dir="asc">â–²</button>
                  <button class="sortbtn" data-sort="grade" data-dir="desc">â–¼</button>
                </span>
              </th>
              <th style="width:120px">
                í•™ê³¼
                <span class="sort-group">
                  <button class="sortbtn" data-sort="dept" data-dir="asc">â–²</button>
                  <button class="sortbtn" data-sort="dept" data-dir="desc">â–¼</button>
                </span>
              </th>
              <th style="width:100px">
                ë°˜
                <span class="sort-group">
                  <button class="sortbtn" data-sort="klass" data-dir="asc">â–²</button>
                  <button class="sortbtn" data-sort="klass" data-dir="desc">â–¼</button>
                </span>
              </th>
              <th style="width:96px">ë°˜ë‚©í™•ì¸</th>
              <th style="width:160px">ë°˜ë‚©ì¼ì‹œ</th>
              <th style="width:160px">ê¸°ë¡ì‹œê°„</th>
              <th style="width:64px" class="center">ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:6px">ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € LocalStorageì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </section>
  </div>

  <!-- ì›”ë³„ í†µê³„ ëª¨ë‹¬ -->
  <dialog id="statsModal">
    <div class="modal">
      <header>
        <h3>ì›”ë³„ í†µê³„</h3>
        <button class="close" id="closeStats">ë‹«ê¸°</button>
      </header>
      <div class="inline" style="gap:12px;margin-bottom:6px">
        <input type="month" id="monthPicker" />
        <button class="btn-ghost" id="buildStatsBtn">í†µê³„ ê³„ì‚°</button>
      </div>
      <div id="statsSummary" class="muted" style="margin-bottom:8px"></div>
      <table style="width:100%">
        <thead><tr><th>ë‚ ì§œ</th><th>ì´ ëŒ€ì—¬</th><th>ë°˜ë‚©</th><th>ë¯¸ë°˜ë‚©</th></tr></thead>
        <tbody id="statsBody"></tbody>
      </table>
    </div>
  </dialog>

  <script>
    // ---------- Storage ----------
    const KEY = "ck_borrow_records_v3";
    function readStore(){ try{const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):{}}catch(e){return {} } }
    function writeStore(o){ localStorage.setItem(KEY, JSON.stringify(o)) }
    function dateISO(d){ const t = (d instanceof Date)? d: new Date(d); return t.toISOString().slice(0,10) }
    function nowISO(){ return new Date().toISOString() }
    function toKo(iso){ if(!iso) return ""; return new Date(iso).toLocaleString("ko-KR",{hour12:true}) }
    function getList(date){ const s=readStore(); return s[date]? s[date]:[] }
    function setList(date, list){ const s=readStore(); s[date]=list; writeStore(s) }

    // ---------- Elements ----------
    const datePicker=document.getElementById("datePicker");
    const periodButtons=document.getElementById("periodButtons");
    const teacherInput=document.getElementById("teacherInput");
    const gradeSelect=document.getElementById("gradeSelect");
    const deptSelect=document.getElementById("deptSelect");
    const classSelect=document.getElementById("classSelect");
    const addBtn=document.getElementById("addBtn");
    const unreturnedOnly=document.getElementById("unreturnedOnly");
    const tableBody=document.getElementById("tableBody");
    const recordCount=document.getElementById("recordCount");
    const statsBtn=document.getElementById("statsBtn");
    const statsModal=document.getElementById("statsModal");
    const closeStats=document.getElementById("closeStats");
    const monthPicker=document.getElementById("monthPicker");
    const tableHead=document.getElementById("tableHead");

    const DEPARTMENTS=["ì „ê¸°","í™”ê³µ","ìŠ¤íŒ¨","ì „ì","ìŠ¤ìœµ","ì†Œí”„íŠ¸"];

    let currentDate=dateISO(new Date());
    let selectedPeriod=null; // 1~7 ë˜ëŠ” 'ë°©ê³¼í›„'

    // ì •ë ¬ ìƒíƒœ
    let sortKey=null; // 'grade' | 'dept' | 'klass'
    let sortDir='asc'; // 'asc' | 'desc'

    function init(){
      // ë‚ ì§œ ê¸°ë³¸ê°’
      datePicker.value=currentDate;
      datePicker.addEventListener("change",()=>{
        currentDate=datePicker.value||dateISO(new Date());
        renderTable();
      });

      // êµì‹œ ë²„íŠ¼: 1~7 + ë°©ê³¼í›„
      for(let i=1;i<=7;i++){ createPeriodButton(String(i), `${i}êµì‹œ`) }
      createPeriodButton("ë°©ê³¼í›„","ë°©ê³¼í›„");

      // í•™ê³¼ ì˜µì…˜ ì‚½ì…
      DEPARTMENTS.forEach(d=>{
        const o=document.createElement("option"); o.value=d; o.textContent=d; deptSelect.appendChild(o);
      });

      addBtn.addEventListener("click", addEntry);
      unreturnedOnly.addEventListener("change", renderTable);

      // í†µê³„ ëª¨ë‹¬
      statsBtn.addEventListener("click",()=>{
        document.getElementById("monthPicker").value=currentDate.slice(0,7);
        buildStats();
        statsModal.showModal();
      });
      closeStats.addEventListener("click",()=>statsModal.close());
      document.getElementById("buildStatsBtn").addEventListener("click", buildStats);

      // thead ì •ë ¬ ë²„íŠ¼ ìœ„ì„
      tableHead.addEventListener('click', (e)=>{
        const btn = e.target.closest('.sortbtn');
        if(!btn) return;
        sortKey = btn.dataset.sort; // grade | dept | klass
        sortDir = btn.dataset.dir;  // asc | desc
        // active í‘œì‹œ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.sortbtn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderTable();
      });

      renderTable();
    }

    function createPeriodButton(value, label){
      const b=document.createElement("button");
      b.className="btn"; b.textContent=label; b.dataset.p=value;
      b.addEventListener("click",()=>{
        selectedPeriod=value;
        [...periodButtons.children].forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
      });
      periodButtons.appendChild(b);
    }

    function addEntry(){
      if(!selectedPeriod){ alert("êµì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return }
      const teacher=teacherInput.value.trim();
      if(!teacher){ alert("ì‚¬ìš©ì(êµì‚¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); teacherInput.focus(); return }

      const entry={
        id: crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2)),
        period:selectedPeriod,
        teacher,
        grade:gradeSelect.value,
        dept:deptSelect.value,
        klass:classSelect.value,
        returned:false,
        returnTime:null,
        createdAt: nowISO(),
      };
      const list=getList(currentDate);
      list.push(entry);
      setList(currentDate,list);

      renderTable();
      teacherInput.focus();
    }

    function renderTable(){
      const list=getList(currentDate);
      const filtered = unreturnedOnly.checked ? list.filter(x=>!x.returned) : list;

      // ì •ë ¬ ë¡œì§
      let rows = [...filtered];
      if(sortKey){
        rows.sort((a,b)=>{
          let cmp = 0;
          if(sortKey === 'dept'){
            cmp = String(a.dept).localeCompare(String(b.dept), 'ko');
          } else if(sortKey === 'grade'){
            cmp = compareNumericLike(a.grade, b.grade); // ex) 1í•™ë…„, 2í•™ë…„
          } else if(sortKey === 'klass'){
            cmp = compareNumericLike(a.klass, b.klass); // ex) 1ë°˜, 2ë°˜
          }
          return sortDir === 'asc' ? cmp : -cmp;
        });
      }

      tableBody.innerHTML="";
      rows.forEach((row, i)=>{
        const tr=document.createElement("tr");
        tr.dataset.id=row.id;
        const periodLabel = (row.period==="ë°©ê³¼í›„") ? "ë°©ê³¼í›„" : `${row.period}êµì‹œ`;
        tr.innerHTML=`
          <td class="center">${i+1}</td>
          <td>${periodLabel}</td>
          <td>${escapeHTML(row.teacher)}</td>
          <td>${row.grade}</td>
          <td>${row.dept}</td>
          <td>${row.klass}</td>
          <td class="center"><input type="checkbox" ${row.returned?"checked":""} data-role="toggle-return"></td>
          <td>${row.returnTime? `<span class="tag ok">${toKo(row.returnTime)}</span>` : `<span class="tag wait">-</span>`}</td>
          <td class="muted">${toKo(row.createdAt)}</td>
          <td class="center"><button class="btn btn-danger" data-role="delete">ì‚­ì œ</button></td>
        `;
        tableBody.appendChild(tr);
      });
      recordCount.textContent=rows.length;
    }

    function compareNumericLike(a, b){
      const na = extractFirstNumber(a);
      const nb = extractFirstNumber(b);
      if(na != null && nb != null){
        return na - nb; // ìˆ«ì ìš°ì„  ë¹„êµ
      }
      // ìˆ«ìê°€ ì—†ê±°ë‚˜ í•œìª½ë§Œ ìˆëŠ” ê²½ìš°: ë¬¸ìì—´ ë¹„êµ(í•œêµ­ì–´ ë¡œì¼€ì¼)
      return String(a).localeCompare(String(b), 'ko');
    }

    function extractFirstNumber(s){
      const m = String(s).match(/\d+/);
      return m ? Number(m[0]) : null;
    }

    function escapeHTML(s){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])) }

    // tbody ì´ë²¤íŠ¸ (ë°˜ë‚© í† ê¸€/ì‚­ì œ)
    tableBody.addEventListener("change",(e)=>{
      const role=e.target.getAttribute("data-role");
      if(role==="toggle-return"){
        const id=e.target.closest("tr").dataset.id;
        const list=getList(currentDate);
        const item=list.find(x=>x.id===id);
        if(item){
          item.returned=e.target.checked;
          item.returnTime=item.returned? nowISO() : null;
          setList(currentDate,list);
          renderTable();
        }
      }
    });
    tableBody.addEventListener("click",(e)=>{
      const role=e.target.getAttribute("data-role");
      if(role==="delete"){
        const id=e.target.closest("tr").dataset.id;
        const list=getList(currentDate);
        const idx=list.findIndex(x=>x.id===id);
        if(idx>=0){ list.splice(idx,1); setList(currentDate,list); renderTable(); }
      }
    });

    function buildStats(){
      const ym = (monthPicker.value || dateISO(new Date()).slice(0,7));
      const s=readStore();
      const days = Object.keys(s).filter(k=>k.startsWith(ym)).sort();
      let sumT=0,sumR=0,sumU=0;
      let rows="";
      days.forEach(d=>{
        const arr=s[d]||[];
        const t=arr.length, r=arr.filter(x=>x.returned).length, u=t-r;
        sumT+=t; sumR+=r; sumU+=u;
        rows += `<tr><td>${d}</td><td>${t}</td><td>${r}</td><td>${u}</td></tr>`;
      });
      document.getElementById("statsBody").innerHTML = rows || `<tr><td colspan="4" class="muted">í•´ë‹¹ ì›” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      document.getElementById("statsSummary").textContent = `${ym} ì´ ${sumT}ê±´ Â· ë°˜ë‚© ${sumR}ê±´ Â· ë¯¸ë°˜ë‚© ${sumU}ê±´`;
    }

    init();
  </script>
</body>
</html>
