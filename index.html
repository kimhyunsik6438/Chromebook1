<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>크롬북 충전함 카드키 대여프로그램</title>
  <style>
    :root{
      --bg:#f6f7fb; --panel:#ffffff; --ink:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --accent:#2563eb; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "맑은 고딕", Arial, sans-serif}
    .wrap{max-width:1180px;margin:22px auto 120px;padding:0 16px}
    h1{margin:0 0 8px;font-size:22px}
    .muted{color:var(--muted);font-size:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:end}
    .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-1{grid-column:span 1}
    label{display:block;font-size:12px;font-weight:700;color:#334155;margin-bottom:6px}
    input[type="text"],input[type="date"],select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .periods{display:flex;gap:6px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-primary{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn-ghost{background:#e0e7ff;color:#1e3a8a;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn-danger{background:var(--danger);color:#fff;border:none;padding:8px 10px;border-radius:10px;cursor:pointer}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{display:none}
    .slider{position:absolute;inset:0;background:#cbd5e1;border-radius:999px;transition:.2s}
    .slider:before{content:"";position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
    .switch input:checked + .slider{background:#86efac}
    .switch input:checked + .slider:before{transform:translateX(20px)}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    thead th{background:#f1f5f9;text-align:left;padding:9px 10px;font-size:12px;color:#334155;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:1}
    tbody td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:last-child td{border-bottom:none}
    .center{text-align:center}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .tag.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .tag.wait{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    dialog{border:none;border-radius:14px;padding:0;width:min(900px,92vw);box-shadow:0 24px 60px rgba(0,0,0,.25)}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal{padding:16px}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal h3{margin:0;font-size:18px}
    .close{background:#eef2ff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>크롬북 충전함 카드키 대여프로그램</h1>

    <!-- 조회 날짜: 입력 패널 밖, 좌측 상단 -->
    <div class="inline" style="justify-content:space-between;margin:8px 0 12px">
      <div>
        <label for="datePicker">조회 날짜</label>
        <input type="date" id="datePicker" style="width:200px"/>
      </div>
      <div class="inline">
        <button class="btn-ghost" id="statsBtn">📊 월별 통계</button>
        <label class="inline" style="gap:6px">
          <span class="muted">미반납만 보기</span>
          <span class="switch"><input type="checkbox" id="unreturnedOnly"><span class="slider"></span></span>
        </label>
      </div>
    </div>

    <!-- 입력 패널 -->
    <section class="panel" aria-label="입력 영역">
      <div class="grid">
        <!-- 순서: 교시 → 사용자 → 학년 → 학과 → 반 → 반납 -->
        <div class="col-3">
          <label>교시 (1~7, 방과후)</label>
          <div id="periodButtons" class="periods"></div>
        </div>

        <div class="col-3">
          <label for="teacherInput">사용자(교사)</label>
          <input type="text" id="teacherInput" placeholder="예: 손성필" autocomplete="off"/>
        </div>

        <div class="col-2">
          <label for="gradeSelect">학년</label>
          <select id="gradeSelect">
            <option value="1학년">1학년</option>
            <option value="2학년">2학년</option>
            <option value="3학년">3학년</option>
          </select>
        </div>

        <div class="col-2">
          <label for="deptSelect">학과</label>
          <select id="deptSelect"></select>
        </div>

        <div class="col-1">
          <label for="classSelect">반</label>
          <select id="classSelect">
            <option value="1반">1반</option>
            <option value="2반">2반</option>
            <option value="3반">3반</option>
          </select>
        </div>

        <div class="col-1 center">
          <label for="createReturned">반납</label>
          <input type="checkbox" id="createReturned" title="등록과 동시에 반납 처리"/>
        </div>

        <div class="col-12 inline" style="justify-content:space-between;margin-top:4px">
          <div class="inline">
            <button class="btn-primary" id="addBtn">＋ 대여 등록</button>
          </div>
          <div class="muted">※ 반납 확인 체크 시, 반납일시가 자동 입력됩니다.</div>
        </div>
      </div>
    </section>

    <!-- 표 -->
    <section class="panel" style="margin-top:14px">
      <div class="inline" style="justify-content:space-between;margin-bottom:6px">
        <span class="muted">오늘 포함 원하는 날짜를 선택해 조회하세요.</span>
        <span class="muted"><span id="recordCount">0</span>건</span>
      </div>
      <table id="dataTable" aria-label="대여 기록 테이블">
        <thead>
          <tr>
            <th style="width:60px">연번</th>
            <th style="width:96px">교시</th>
            <th>사용자(교사)</th>
            <th style="width:80px">학년</th>
            <th style="width:90px">학과</th>
            <th style="width:70px">반</th>
            <th style="width:96px">반납확인</th>
            <th style="width:210px">반납일시</th>
            <th style="width:210px">기록시간</th>
            <th style="width:64px" class="center">삭제</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="muted" style="margin-top:6px">데이터는 브라우저 LocalStorage에 자동 저장됩니다.</div>
    </section>
  </div>

  <!-- 월별 통계 모달 -->
  <dialog id="statsModal">
    <div class="modal">
      <header>
        <h3>월별 통계</h3>
        <button class="close" id="closeStats">닫기</button>
      </header>
      <div class="inline" style="gap:12px;margin-bottom:6px">
        <input type="month" id="monthPicker" />
        <button class="btn-ghost" id="buildStatsBtn">통계 계산</button>
      </div>
      <div id="statsSummary" class="muted" style="margin-bottom:8px"></div>
      <table style="width:100%">
        <thead><tr><th>날짜</th><th>총 대여</th><th>반납</th><th>미반납</th></tr></thead>
        <tbody id="statsBody"></tbody>
      </table>
    </div>
  </dialog>

  <script>
    // ---------- Storage ----------
    const KEY = "ck_borrow_records_v3";
    function readStore(){ try{const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):{}}catch(e){return {}} }
    function writeStore(o){ localStorage.setItem(KEY, JSON.stringify(o)) }
    function dateISO(d){ const t = (d instanceof Date)? d: new Date(d); return t.toISOString().slice(0,10) }
    function nowISO(){ return new Date().toISOString() }
    function toKo(iso){ if(!iso) return ""; return new Date(iso).toLocaleString("ko-KR",{hour12:true}) }
    function getList(date){ const s=readStore(); return s[date]? s[date]:[] }
    function setList(date, list){ const s=readStore(); s[date]=list; writeStore(s) }

    // ---------- Elements ----------
    const datePicker=document.getElementById("datePicker");
    const periodButtons=document.getElementById("periodButtons");
    const teacherInput=document.getElementById("teacherInput");
    const gradeSelect=document.getElementById("gradeSelect");
    const deptSelect=document.getElementById("deptSelect");
    const classSelect=document.getElementById("classSelect");
    const createReturned=document.getElementById("createReturned");
    const addBtn=document.getElementById("addBtn");
    const unreturnedOnly=document.getElementById("unreturnedOnly");
    const tableBody=document.getElementById("tableBody");
    const recordCount=document.getElementById("recordCount");
    const statsBtn=document.getElementById("statsBtn");
    const statsModal=document.getElementById("statsModal");
    const closeStats=document.getElementById("closeStats");
    const monthPicker=document.getElementById("monthPicker");
    const statsSummary=document.getElementById("statsSummary");
    const statsBody=document.getElementById("statsBody");

    // 학과 (요청: '전자' 2회 포함)
    const DEPARTMENTS=["전기","화공","스패","전자","스융","소프트"];

    let currentDate=dateISO(new Date());
    let selectedPeriod=null; // 1~7 또는 '방과후'

    // ---------- Init ----------
    function init(){
      // 날짜 기본값
      datePicker.value=currentDate;
      datePicker.addEventListener("change",()=>{
        currentDate=datePicker.value||dateISO(new Date());
        renderTable();
      });

      // 교시 버튼: 1~7 + 방과후
      for(let i=1;i<=7;i++){ createPeriodButton(String(i), `${i}교시`) }
      createPeriodButton("방과후","방과후");

      // 학과 옵션 삽입
      DEPARTMENTS.forEach(d=>{
        const o=document.createElement("option"); o.value=d; o.textContent=d; deptSelect.appendChild(o);
      });

      // 버튼 이벤트
      addBtn.addEventListener("click", addEntry);
      unreturnedOnly.addEventListener("change", renderTable);

      // 통계 모달
      statsBtn.addEventListener("click",()=>{
        monthPicker.value=currentDate.slice(0,7);
        buildStats();
        statsModal.showModal();
      });
      closeStats.addEventListener("click",()=>statsModal.close());
      document.getElementById("buildStatsBtn").addEventListener("click", buildStats);

      renderTable();
    }

    function createPeriodButton(value, label){
      const b=document.createElement("button");
      b.className="btn"; b.textContent=label; b.dataset.p=value;
      b.addEventListener("click",()=>{
        selectedPeriod=value;
        [...periodButtons.children].forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
      });
      periodButtons.appendChild(b);
    }

    // ---------- Add ----------
    function addEntry(){
      if(!selectedPeriod){ alert("교시를 선택하세요."); return }
      const teacher=teacherInput.value.trim();
      if(!teacher){ alert("사용자(교사)를 입력하세요."); teacherInput.focus(); return }

      const returned = !!createReturned.checked;
      const entry={
        id: crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2)),
        period:selectedPeriod, // 1~7 또는 '방과후'
        teacher,
        grade:gradeSelect.value,
        dept:deptSelect.value,
        klass:classSelect.value,
        returned,
        returnTime: returned ? nowISO() : null,
        createdAt: nowISO(),
      };
      const list=getList(currentDate);
      list.push(entry);
      setList(currentDate,list);

      createReturned.checked=false;
      renderTable();
      teacherInput.focus();
    }

    // ---------- Render ----------
    function renderTable(){
      const list=getList(currentDate);
      const filtered = unreturnedOnly.checked ? list.filter(x=>!x.returned) : list;

      tableBody.innerHTML="";
      filtered.forEach((row, i)=>{
        const tr=document.createElement("tr");
        tr.dataset.id=row.id;
        const periodLabel = (row.period==="방과후") ? "방과후" : `${row.period}교시`;
        tr.innerHTML=`
          <td class="center">${i+1}</td>
          <td>${periodLabel}</td>
          <td>${escapeHTML(row.teacher)}</td>
          <td>${row.grade}</td>
          <td>${row.dept}</td>
          <td>${row.klass}</td>
          <td class="center"><input type="checkbox" ${row.returned?"checked":""} data-role="toggle-return"></td>
          <td>${row.returnTime? `<span class="tag ok">${toKo(row.returnTime)}</span>` : `<span class="tag wait">-</span>`}</td>
          <td class="muted">${toKo(row.createdAt)}</td>
          <td class="center"><button class="btn-danger" data-role="delete">삭제</button></td>
        `;
        tableBody.appendChild(tr);
      });
      recordCount.textContent=filtered.length;
    }

    function escapeHTML(s){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // 테이블 이벤트: 반납 토글/삭제
    tableBody.addEventListener("change",(e)=>{
      const role=e.target.getAttribute("data-role");
      if(role==="toggle-return"){
        const id=e.target.closest("tr").dataset.id;
        const list=getList(currentDate);
        const item=list.find(x=>x.id===id);
        if(item){
          item.returned=e.target.checked;
          item.returnTime=item.returned? nowISO() : null;
          setList(currentDate,list);
          renderTable();
        }
      }
    });
    tableBody.addEventListener("click",(e)=>{
      const role=e.target.getAttribute("data-role");
      if(role==="delete"){
        const id=e.target.closest("tr").dataset.id;
        const list=getList(currentDate);
        const idx=list.findIndex(x=>x.id===id);
        if(idx>=0){ list.splice(idx,1); setList(currentDate,list); renderTable(); }
      }
    });

    // ---------- Stats ----------
    function buildStats(){
      const ym = (monthPicker.value || dateISO(new Date()).slice(0,7));
      const s=readStore();
      const days = Object.keys(s).filter(k=>k.startsWith(ym)).sort();
      let sumT=0,sumR=0,sumU=0;
      let rows="";
      days.forEach(d=>{
        const arr=s[d]||[];
        const t=arr.length, r=arr.filter(x=>x.returned).length, u=t-r;
        sumT+=t; sumR+=r; sumU+=u;
        rows += `<tr><td>${d}</td><td>${t}</td><td>${r}</td><td>${u}</td></tr>`;
      });
      statsBody.innerHTML = rows || `<tr><td colspan="4" class="muted">해당 월 데이터가 없습니다.</td></tr>`;
      statsSummary.textContent = `${ym} 총 ${sumT}건 · 반납 ${sumR}건 · 미반납 ${sumU}건`;
    }

    // ---------- Boot ----------
    init();
  </script>
</body>
</html>
